<!-- layout file includes stylesheets and external js libraries -->
<% layout('layout') -%>

<script src="/javascripts/bargraph_helper.js"></script>
<h1><%= title %></h1>
<br>

<div name="bargraph-container">
  <p>Below is a chart of the user <b><%= user %></b>'s nodes per date</p>
  <svg class="chart" id="chart1"></svg>

  <div class="loader" >
    <span>Loading</span>
    <img src="/images/ajax-loader.gif"/>
  </div>
</div>

<script>

var localData;

// Get username from URL
var theUser = <%- JSON.stringify(user) %>
var start_date = <%- JSON.stringify(start_date) %>
var end_date = <%- JSON.stringify(end_date) %>

// Actually get the data
$( document ).ready(function() {
  // Handler for .ready() called.
  fetchNodes(theUser);
});

function toggleLoader(message) 
{
  if (message) 
  {
    $('.loader').show().find('span').text(message);
    return;
  }
  $('.loader').hide();
}

function fetchNodes(username) 
{
    var url = '/nodes?username='+username+'&date='+start_date+'&end_date='+end_date;
    toggleLoader('Fetching nodes for user '+username);

    $.get(url).done(function(results) {
        toggleLoader();
        if (results)
        {
          localData = results;
          chart("#chart1","key","date");
        }
        else
        {
          $('#chart1').html = "ERROR!! :((";
        }
    });
}

</script>

<div>
  <button onClick="chart('#chart1','key','date')">Sort by Time</button>
  <button onClick="chart('#chart1','value','date')">Sort by Frequency</button>
</div>